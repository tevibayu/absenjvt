<!DOCTYPE html>
<html>
 <head>
  <title>MQTT signaling</title>
  <meta charset="urt-8"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
 </head>
 <body>
  <button type="button" onclick="startVideo();">Start video</button>
  <button type="button" onclick="stopVideo();">Stop video</button>
      
  <button type="button" onclick="connect();">Connect</button>
  <button type="button" onclick="hangUp();">Hang Up</button>
  <br />
  <div id='video-space'>
   <video id="local-video" autoplay style="width: 100%; height: 50%; border: 1px solid black;"></video>
   <video id="remote-video" autoplay style="width: 100%; height: 50%; border: 1px solid black;"></video>
  </div>

  <div id="alert"></div>

 </body>
 <script>
  var localVideo = document.getElementById('local-video');
  var remoteVideo = document.getElementById('remote-video');
  var localStream = null;
  var peerConnection = null;
  var peerStarted = false;
  var mediaConstraints = {'mandatory': {'OfferToReceiveAudio':false, 'OfferToReceiveVideo':true }};
  //var mediaConstraints = {'mandatory': {'OfferToReceiveAudio':true, 'OfferToReceiveVideo':true }};
  
  function onSDPText() {
   var text = textToReceiveSDP.value;
   if (peerConnection) {
    onAnswerText(text);
   }
   else {
    onOfferText(text);
   }
   textToReceiveSDP.value ="";
  }

  function onOfferText(text) {
   console.log("Received offer text...")
   document.getElementById('alert').innerHTML += text + '<br>';
   console.log(text);
   setOfferText(text);
   makeAnswer();
  }

  function onAnswerText(text) {
   console.log("Received answer text...")
   document.getElementById('alert').innerHTML += text + '<br>';
   console.log(text);
   setAnswerText(text);
  }

  function sendSDPText(text) {
   console.log("---sending sdp text ---");
   console.log(text);
   document.getElementById('alert').innerHTML += text + '<br>';

   textForSendSDP.value = text;
   textForSendSDP.focus();
   textForSendSDP.select();
  }

  // ---------------------- video handling -----------------------
  // start local video
  function startVideo() {

    document.getElementById('alert').innerHTML += 'Connecting...<br>';
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    var constraints = {audio: false, video: true};
    var video = localVideo;

    function successCallback(stream) {
      // stream available to console so you could inspect it and see what this object looks like
      window.stream = stream;
      localStream = stream;
      video.srcObject = stream;

      document.getElementById('alert').innerHTML += stream + '<br>';

      video.onloadedmetadata = function(e) {
        video.play();
      };
    }

    function errorCallback(error) {
      document.getElementById('alert').innerHTML += error.message + '<br>';
    }

    navigator.getUserMedia(constraints, successCallback, errorCallback);

   
  }

  // stop local video
  function stopVideo() {
   localVideo.srcObject = "";
   localStream.stop();
  }

  // ---------------------- connection handling -----------------------
  function prepareNewConnection() {
   var pc_config = {"iceServers":[]};
   var peer = null;
   try {
    peer = new RTCPeerConnection(pc_config);
   } catch (e) {
    console.log("Failed to create peerConnection, exception: " + e.message);
    document.getElementById('alert').innerHTML += e.message + '<br>';
   }

   // send any ice candidates to the other peer
   peer.onicecandidate = function (evt) {
    if (evt.candidate) {
     console.log(evt.candidate);
    } else {
     console.log("ice event phase =" + evt.eventPhase);
     sendSDPTextMQTT(peer.localDescription.type, peer.localDescription.sdp);
    }
   };

   peer.oniceconnectionstatechange = function() {
    console.log('ice connection status=' + peer.iceConnectionState + ' gahter=' + peer.iceGatheringState);
    if ('completed' === peer.iceConnectionState) {
     console.log("candidate complete");
     document.getElementById('alert').innerHTML += "candidate complete" + '<br>';
    }
   };

   peer.onsignalingstatechange = function() {
    console.log('signaling status=' + peer.signalingState);
    document.getElementById('alert').innerHTML += 'signaling status=' + peer.signalingState + '<br>';
   };

   console.log('Adding local stream...');
   document.getElementById('alert').innerHTML += 'Adding local stream...' + '<br>';
   peer.addStream(localStream);

   peer.addEventListener("addstream", onRemoteStreamAdded, false);
   peer.addEventListener("removestream", onRemoteStreamRemoved, false)

   // when remote adds a stream, hand it on to the local video element
   function onRemoteStreamAdded(event) {
    console.log("Added remote stream");
    document.getElementById('alert').innerHTML += "Added remote stream" + '<br>';
    remoteVideo.src = window.webkitURL.createObjectURL(event.stream);
   }

   // when remote removes a stream, remove it from the local video element
   function onRemoteStreamRemoved(event) {
    console.log("Remove remote stream");
    document.getElementById('alert').innerHTML += "Remove remote stream" + '<br>';
    remoteVideo.src = "";
   }

   return peer;
  }

  function makeOffer() {
   unsubscribe("offer");
   subscribe("answer");
   peerConnection = prepareNewConnection();
   peerConnection.createOffer(function (sessionDescription) { // in case of success
    peerConnection.setLocalDescription(sessionDescription);
    console.log("Sending: SDP");
    console.log(sessionDescription);
   }, function () { // in case of error
    console.log("Create Offer failed");
    document.getElementById('alert').innerHTML += 'Create Offer failed' + '<br>';
   }, mediaConstraints);
  }

  function setOfferText(text) {
   if (peerConnection) {
    console.error('peerConnection alreay exist!');
    document.getElementById('alert').innerHTML += 'peerConnection alreay exist!' + '<br>';
   }
   peerConnection = prepareNewConnection();
   var offer = new RTCSessionDescription({
    type : 'offer',
    sdp : text,
   });
   peerConnection.setRemoteDescription(offer);
  }


  function makeAnswer(evt) {
   console.log('sending Answer. Creating remote session description...' );
   if (! peerConnection) {
    console.error('peerConnection NOT exist!');
    document.getElementById('alert').innerHTML += 'peerConnection NOT exist!' + '<br>';
    return;
   }

   peerConnection.createAnswer(function (sessionDescription) { // in case of success
    peerConnection.setLocalDescription(sessionDescription);
    console.log("Sending: SDP");
    console.log(sessionDescription);
   }, function () { // in case of error
    console.log("Create Answer failed");
    document.getElementById('alert').innerHTML += "Create Answer failed" + '<br>';
   }, mediaConstraints);
  }

  function setAnswerText(text) {
   if (! peerConnection) {
    console.error('peerConnection NOT exist!');
    document.getElementById('alert').innerHTML += 'peerConnection NOT exist!' + '<br>';
    return;
   }
   var answer = new RTCSessionDescription({
    type : 'answer',
    sdp : text,
   });
   peerConnection.setRemoteDescription(answer);
  }


  // -------- handling user UI event -----
  // start the connection upon user request
  function connect() {
   if (!peerStarted && localStream) {
    makeOffer();
    peerStarted = true;
   } else {
    alert("Local stream not running yet - try again.");
    document.getElementById('alert').innerHTML += "Local stream not running yet - try again." + '<br>';
   }
  }

  // stop the connection upon user request
  function hangUp() {
   console.log("Hang up.");
   document.getElementById('alert').innerHTML += "Hang up." + '<br>';
   stop();
  }

  function stop() {
   peerConnection.close();
   peerConnection = null;
   peerStarted = false;
  }

  // ---------------------------
  // from 
  // http://tdoc.info/blog/2014/09/25/mqtt_javascript.html

  var clientId = "web_client_01";
  var user_name = "efa1c93f5bef0004d162a56d92463059";
  var pass = "9417a3205b4af238af3a50a425336538";
  var wsurl = "odchat.dok.outletdecor.com";
  var port = '8083';

  // connect to MQTT broker
  var client = new Paho.MQTT.Client(wsurl, Number(port), clientId);
  client.connect({userName: user_name, password: pass, useSSL: true, onSuccess:onConnect, onFailure: failConnect});

  function failConnect(e) {
   console.log("connect failed");
   document.getElementById('alert').innerHTML += "connect failed" + '<br>';
   console.log(e);
  }

  function onConnect() {
   console.log("onConnect");
   document.getElementById('alert').innerHTML += "onConnect" + '<br>';
   subscribe("offer");
  }

  function buildTopic(signalingType) {
   var topic = '5c5c22585cc12387005fc70b281e28fc/' + clientId + '/signaling/' + signalingType;
   return topic;
  }

  // callback for receiving message
  function onMessageArrived(message) {
   console.log("onMessageArrived:" + message.destinationName + ' -- ' + message.payloadString);
   document.getElementById('alert').innerHTML += "onMessageArrived:" + message.destinationName + ' -- ' + message.payloadString + '<br>';

   if (message.destinationName === buildTopic('answer')) {
    onAnswerText(message.payloadString)
   }
   else if (message.destinationName === buildTopic('offer')) {
    onOfferText(message.payloadString)
   }
   else {
    console.warn('Bad SDP topic');
    document.getElementById('alert').innerHTML += 'Bad SDP topic' + '<br>';
   }
  }

  function subscribe(waitType) {
   // set callback
   client.onMessageArrived = onMessageArrived;
   
   // Subscribe
   var topic = buildTopic(waitType);
   client.subscribe(topic);

   document.getElementById('alert').innerHTML += "subcribed" + '<br>';
  }

  function unsubscribe(waitType) {
   // UnSubscribe 
   var topic = buildTopic(waitType);
   client.unsubscribe(topic);
   document.getElementById('alert').innerHTML += "unsubcribed" + '<br>';
  }

  function sendSDPTextMQTT(type, text){
   var topic = buildTopic(type);
   message = new Paho.MQTT.Message(text);
   message.destinationName = topic;
   client.send(message);
  }

 </script>
</html>